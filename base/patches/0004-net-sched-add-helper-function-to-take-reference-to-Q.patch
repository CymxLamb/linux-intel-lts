From bba0655cfc50e2211b70043089862ca316be4fd3 Mon Sep 17 00:00:00 2001
From: Thomas Bogendoerfer <tbogendoerfer@suse.de>
Date: Fri, 11 Mar 2022 15:58:13 +0100
Subject: [PATCH 4/5] net: sched: add helper function to take reference to
 Qdisc (bsc#1196973 CVE-2021-39713).

suse-commit: 9d1e163478cf17bdd1eb533a8869bf5a2031f3c2
---
 include/net/sch_generic.h | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/include/net/sch_generic.h b/include/net/sch_generic.h
index 5ddd4ad16df6..ad73c22b537e 100644
--- a/include/net/sch_generic.h
+++ b/include/net/sch_generic.h
@@ -110,6 +110,19 @@ static inline void qdisc_refcount_inc(struct Qdisc *qdisc)
 	refcount_inc(&qdisc->refcnt);
 }
 
+/* Intended to be used by unlocked users, when concurrent qdisc release is
+ * possible.
+ */
+
+static inline struct Qdisc *qdisc_refcount_inc_nz(struct Qdisc *qdisc)
+{
+	if (qdisc->flags & TCQ_F_BUILTIN)
+		return qdisc;
+	if (refcount_inc_not_zero(&qdisc->refcnt))
+		return qdisc;
+	return NULL;
+}
+
 static inline bool qdisc_is_running(const struct Qdisc *qdisc)
 {
 	return (raw_read_seqcount(&qdisc->running) & 1) ? true : false;
-- 
2.25.1

